# !pip install mlflow
import mlflow
import mlflow.sklearn
import mlflow.xgboost

//
# Initialize MLflow
mlflow.set_experiment("Anomaly Detection")
# mlflow.set_tracking_uri("http://localhost:5000")

for i, element in enumerate(models):
    model_name = element[0]
    params = element[1]
    model = element[2]
    report = reports[i]

    with mlflow.start_run(run_name=model_name):
        mlflow.log_params(params)
        mlflow.log_metrics({
            'accuracy': report['accuracy'],
            'recall_class_1': report['1']['recall'],
            'recall_class_0': report['0']['recall'],
            'f1_score_macro': report['macro avg']['f1-score']
        })

        if "XGB" in model_name:
            mlflow.xgboost.log_model(model, "model")
        else:
            mlflow.sklearn.log_model(model, "model")

        # if "XGB" in model_name:
        #     model_uri = f"runs:/{run_id}/model"
        #     mlflow.register_model(model_uri=model_uri, name=model_name)

        #     print(f"Model {model_name} registered with run_id: {run_id}")

//

#Register the Model¶
# model_uri = f"runs:/{run_id}/model"
# mlflow.register_model(model_uri=model_uri, name=model_name)
# print(f"Model {model_name} registered with run_id: {run_id}")

//
import mlflow

mlflow.set_experiment("Anomaly Detection")
# Optional: set your tracking URI if remote
# mlflow.set_tracking_uri("http://localhost:5000")

for i, element in enumerate(models):
    model_name = element[0]
    params = element[1]
    model = element[2]
    report = reports[i]

    with mlflow.start_run(run_name=model_name) as run:
        run_id = run.info.run_id

        # Log parameters and metrics
        mlflow.log_params(params)
        mlflow.log_metrics({
            'accuracy': report['accuracy'],
            'recall_class_1': report['1']['recall'],
            'recall_class_0': report['0']['recall'],
            'f1_score_macro': report['macro avg']['f1-score']
        })

        # Log model
        if "XGB" in model_name:
            mlflow.xgboost.log_model(model, "model")
        else:
            mlflow.sklearn.log_model(model, "model")

        # ✅ Register the model (inside the active run)
        model_uri = f"runs:/{run_id}/model"
        mlflow.register_model(model_uri=model_uri, name=model_name)

        print(f"✅ Model {model_name} registered successfully with run_id: {run_id}")
//

mlflow.register_model(model_uri=f"runs:/{run_id}/model", name="XGB-Smote")

#Load the Model
import mlflow.xgboost

model_name = "XGB-Smote"
model_version = 1
model_uri = f"models:/{model_name}/{model_version}"

loaded_model = mlflow.xgboost.load_model(model_uri)

# Predict
y_pred = loaded_model.predict(X_test)
print(y_pred[:])

//
model_version = 1
model_uri = f"models:/{model_name}/{model_version}"

loaded_model = mlflow.xgboost.load_model(model_uri)
y_pred = loaded_model.predict(X_test)
y_pred[:4]

//
import mlflow
from mlflow.tracking import MlflowClient

model_name = "XGB-Smote"                # Source model
production_model_name = "anomaly-detection-prod"  # Destination registry
source_version = 1

client = MlflowClient()

# Set alias "challenger" on source model
client.set_registered_model_alias(model_name, "challenger", version=source_version)

# Make sure destination model registry exists
try:
    client.create_registered_model(production_model_name)
except Exception:
    pass  # Already exists

# Copy challenger into production registry
dst_model_version = client.copy_model_version(
    src_model_uri=f"models:/{model_name}@challenger",
    dst_name=production_model_name
)

# Set alias "champion" on the copied version
client.set_registered_model_alias(
    production_model_name,
    "champion",
    version=dst_model_version.version
)

#Load champion model & predict 
prod_model_uri = f"models:/{production_model_name}@champion"
loaded_model = mlflow.xgboost.load_model(prod_model_uri)

y_pred = loaded_model.predict(X_test)
print(y_pred[:4])

//
model_version = 1
prod_model_uri = f"models:/{production_model_name}@champion"

loaded_model = mlflow.xgboost.load_model(prod_model_uri)
y_pred = loaded_model.predict(X_test)
y_pred[:4]